<!DOCTYPE html>
<html>
  <head>

        <!--Stuff for da browser and embeds-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Deicto">
    <meta property="og:description" content="Deicto is a free, non-profit platform for expanding your vocabulary in foreign languages.">
    <meta property="og:image" content="https://rigelium.github.io/deicto/assets/logo.png">
    <link rel="icon" type="image/x-icon" href="https://rigelium.github.io/deicto/assets/logo_cat.png">

    
    <link rel="stylesheet" href="assets/styles.css">
    <title>Deicto</title>
  </head>
  <body>

     <div style="position: fixed; top: 0px; right: 0px; width: 100%; height: 80px; background-color: black; display: flex; justify-content: space-between; align-items: center;">
      <div onclick='window.location.href=("")' style="height: 80%; margin: 10px;"><img src="assets/logo.png" style="height: 100%;"></div>
      <div onclick='document.getElementById("options").style.display = "flex"'style="display: flex; justify-content: flex-end; flex-direction: column; justify-content: space-between; height: 40%; margin-right: 10px;">      
      <div style="width: 40px; height: 6px; background-color: white; border-radius: 3px;"></div>
      <div style="width: 40px; height: 6px; background-color: white; border-radius: 3px;"></div><div style="width: 40px; height: 6px; background-color: white; border-radius: 5px;"></div>
      </div>
    </div>
    <div style="height: 90px;"></div>


    <!-- ADD COURSES // ALL COURSES -->
    <div id="add-courses" class="centerfix" style="width: 100%; height: 100%; flex-direction: column; display: none; background-color: var(--bgcolor); z-index: 100; transform: translate(-50%, calc(-50% + 80px));">
      <div style='display: flex; justify-content: space-between; margin: 10px 5px 0 5px;'>
        <a style='font-size: 1.5rem;'>All courses</a>
        <img src="assets/cross.png" onclick="hideCourses(); history.back()" style="height: 1.5rem; width: 1.5rem;">
      </div>
      <div id='course-list' style='overflow-y: auto;'></div>
    </div>


    

    <!-- MY COURSES -->
    <div class="box1" style="flex-direction: column;">
    <a style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">My courses</a>
    <div class="box1" style="background-color: var(--bgcolor); height: 60px; width: 95%; overflow: hidden; justify-content: space-between; gap: 10px;">
    <div id='flag-container' style="overflow-x: auto; display: flex; gap: 10px; border-radius: 5px;">
    </div>
    <div onclick='displayCourses()' class = 'box2' style="width: 60px;">
        <img src="assets/plus.png" style='height: 100%;'>
        </div>
      </div>
    </div>

    <!-- LANGUAGE MENU -->
    <div class="box1" style="margin-top: 10px; flex-direction: column;">
      <div style="display: flex; gap: 10px;">
        <div style="width: 160px;">
          <img id='menu-flag' src="assets/flags/Spanish.png" style="width: 100%; border-radius: 10px; aspect-ratio: 3 / 2;">
          <a id='menu-lang-name' style="font-size: 1.5rem; font-weight: bold; margin: 10px 0 10px 0;">Spanish</a>
        </div>
        <div id="dif-container" style="display: flex; flex-wrap: wrap; height: 2rem; gap: 5px;">
          <div class="box3">
            <a>beginner</a>
          </div>
          <div class="box3">
            <a>intermediate</a>
          </div>
          <div class="box3">
            <a>advanced</a>
          </div>
        </div>
      </div>
    <div class="box2" onclick="window.location.href = 'levels/'">
      <a style='user-select: none;'>Levels</a>
    </div>
    </div>

    <!-- SAVE PROGRESS-->
    <div class="box1" style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
      <a style="font-size: 1.5rem; font-weight: bold;">Manage progress</a>
      <a style="color: var(--fontcolor3)">Download a backup of your Deicto progress, store the file somewhere securely</a><div style="display: flex; gap: 5px;">
        <div onclick="backupLocalStorage()" class="box3">
          <a>Export progress</a>
        </div>
        <label class="box3">
          <input type="file" id="fileInput" accept=".txt" style="display: none;">Restore progress
        </label>
      </div>
    </div>

    <div id='options' class='box1 centerfix' class='centerfix' style='width: 80%; flex-direction: column; display: none;'>
      <a style='font-size: 2rem;'>Menu</a>
      <a>About</a>
      <a>Options</a>
    </div>




    <div style="height: 2000px; width: 100%;"></div>
    
    <input id="input">Select language</input>
    <button id="btn" onclick="saveLocal()">Set data</button>
        <input id="code-input">Select code</input>
    <button id="code-btn" onclick="codeSaveLocal()">Set data</button>
    <input id="dif-input">Select dif</input>
    <button id="dif-btn" onclick="difSaveLocal()">Set data</button>

    <button onclick="localStorage.clear()">Warning! This button deletes your data</button>

    
    <script>
      let myCourses = [];
      
      //language parameters are already defined

      
      let language = retrieveVariable("language", 'Spanish');
      let langCodeTTS = retrieveVariable("langCodeTTS", 'es-ES'); 
      let difLevel = retrieveVariable(`${language}-difLevel`, "beginner");

      updateMenu(language);
      
      let courses = null;
      window.onload = loadCourses();
      async function loadCourses() {
        try {
          const response = await fetch('levels/courses.json');
          coursesJSON = await response.json();
          courses = coursesJSON.courses;
        } catch(error) {
          console.log(error);
        }
        changeLang(stringToId(language));
        loadList();
        displayFlags();
      }

      function loadList() {
        myCourses[0] = Number(retrieveVariable('myCourses-0', 0));
        for (let i = 1; i < courses.length ; i++) {
          myCourses[i] = Number(retrieveVariable(`myCourses-${i}` , -1));
        }
      }

      function displayCourses(){
        const courseContainer = document.getElementById("add-courses");
        const courseList = document.getElementById("course-list");
        
        history.pushState({ popup: true }, "");
        

        let coursesHTML = "";
        for(let i = 0; i < courses.length ; i++){
          let buttonHTML = "";
          if(myCourses.includes(i) == true){
            buttonHTML = `
            <div onclick='hideCourse(${i})' class="box2" style="display: flex; flex-direction: column; gap: 5px; width: 60px; align-items: center; background: var(--boxgradient2);">
              <img src="assets/cross.png" style="height: 30px;">
              <a>Hide</a>
            </div>
            `;
          } else {
            buttonHTML = `
            <div onclick='addCourse(${i})' class="box2" style="display: flex; flex-direction: column; gap: 5px; width: 60px; align-items: center;">
              <img src="assets/plus.png" style="height: 30px;">
              <a>Add</a>
            </div>
            `;
          }
          coursesHTML += `
          <div class="box1" style="justify-content: space-between; gap: 10px; margin-top: 10px;">
            <div style="display: flex; gap: 5px;">
              <img src="assets/flags/${courses[i].name}.png" style="width: 120px; height: 80px; border-radius: 10px;">
              <div style="display: flex; flex-direction: column; gap: 5px;">
                <a style="font-size: 1.5rem; font-weight: bold;">${courses[i].name}</a>
                <a style="color: var(--fontcolor3)">${courses[i].difLevels.join(', ')}</a>
              </div>
            </div>
            <div id="course-button-container-${i}">
              ${buttonHTML}
            </div>
          </div>
          `
        }
        coursesHTML += `
        <div style='height: 100px; width: 100%'>
          
        </div>
        `;
        courseList.innerHTML = coursesHTML;
        courseContainer.style.display = "flex";
      }

      function hideCourses() {
        document.getElementById('add-courses').style.display = 'none';
      }
      
      window.addEventListener('popstate', (event) => {
      // If the user goes back, hide the popup
      hideCourses();
      });

      function displayFlags() {
        let flagsHTML = '';
        const flagContainer = document.getElementById('flag-container');

        for (let i = 0; i < courses.length; i++) {
          if (myCourses[i] != -1){
            flagsHTML += `
            <img onclick = 'changeLang(${myCourses[i]}); hideCourse(langID); addCourse(langID)' src='assets/flags/${courses[myCourses[i]].name}.png' style='height: 100%; border-radius: 5px; aspect-ratio: 3 / 2;'>
            `;
          }
        }
        flagContainer.innerHTML = flagsHTML;
      }

      function addCourse(newCourse) {
        if(!myCourses.includes(newCourse)){
          myCourses = [newCourse].concat(myCourses);
        }
        for (let i = 0; i < courses.length; i++) {
          localStorage.setItem(`myCourses-${i}`, myCourses[i]);
        }
        displayFlags();
        document.getElementById(`course-button-container-${newCourse}`).innerHTML = `
            <div onclick='hideCourse(${newCourse})' class="box2" style="display: flex; flex-direction: column; gap: 5px; width: 60px; align-items: center; background: var(--boxgradient2);">
              <img src="assets/cross.png" style="height: 30px;">
              <a>Hide</a>
            </div>
            `;
      }
      
      function hideCourse(courseToRemove) {
        myCourses = myCourses.slice(0, myCourses.indexOf(courseToRemove)).concat(myCourses.slice(myCourses.indexOf(courseToRemove) + 1)).concat(-1);
        for (let i = 0; i < courses.length; i++) {
          localStorage.setItem(`myCourses-${i}`, myCourses[i]);
        }      
        displayFlags();
        document.getElementById(`course-button-container-${courseToRemove}`).innerHTML = `
             <div onclick='addCourse(${courseToRemove})' class="box2" style="display: flex; flex-direction: column; gap: 5px; width: 60px; align-items: center;">
              <img src="assets/plus.png" style="height: 30px;">
              <a>Add</a>
            </div>
            `;
        
      }


      function changeLang(langID){
        localStorage.setItem("language", courses[langID].name);
        localStorage.setItem("langCodeTTS", courses[langID].langCode);
        console.log(`changed to ${courses[langID].name}`);

        
        updateMenu(courses[langID].name);
        loadDifs(langID);
      }

      function loadDifs(langID){
        const difContainer = document.getElementById("dif-container");

        const difList = courses[langID].difLevels;
        
        let difHTML = "";
        for (let i = 0; i < difList.length; i++){

          let boxType = 'box3';
          if ( retrieveVariable(`${courses[langID].name}-difLevel`, "beginner") == difList[i] ) {
            boxType = 'box2';
          }
          
          difHTML += `
          <div class="${boxType}" onclick="localStorage.setItem('${courses[langID].name}-difLevel', '${difList[i]}'); loadDifs(${langID})">
            <a>${difList[i]}</a>
          </div>`;
          }
        difContainer.innerHTML = difHTML;
      }
      
      const input = document.getElementById('input');
      const btn = document.getElementById('btn');
      

      const difInput = document.getElementById('dif-input');
      const difBtn = document.getElementById('dif-btn');

const codeInput = document.getElementById('code-input');
      const codeBtn = document.getElementById('code-btn');
      
      function saveLocal() {
        localStorage.setItem('language', input.value);
        console.log("changed language to " + input.value);
      }
      function difSaveLocal() {
        localStorage.setItem(`${language}-difLevel`, difInput.value);
         console.log("changed dif to " + difInput.value);
      }
      function codeSaveLocal() {
        localStorage.setItem('langCodeTTS', codeInput.value);
         console.log("changed code to " + codeInput.value);
      }

              
      function updateMenu(chLang){
        const menuLangName = document.getElementById('menu-lang-name');
        const menuFlag = document.getElementById('menu-flag');
        menuLangName.textContent = chLang;
        menuFlag.src = `assets/flags/${chLang}.png`;
      }

      function stringToId(string){
        for (let i = 0; i < courses.length; i++){
          if (string == courses[i].name)
            return i;
        }
      }
      
      function retrieveVariable(varName, defaultValue) {
        try {
          const storedValue = localStorage.getItem(varName);
          if (storedValue == null){
            return defaultValue;
          }
          return storedValue;
        } catch(error) {
          console.error(error);
          return defaultValue;
        }
      }

function backupLocalStorage() {
    const data = JSON.stringify(localStorage);
    // Encode the string to Base64
    const scrambled = btoa(unescape(encodeURIComponent(data))); 

    const blob = new Blob([scrambled], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;

    currentDate = new Date;
    link.download = `deicto_backup_${currentDate.getDate()}-${currentDate.getMonth() + 1}-${currentDate.getYear() - 100}_${currentDate.getHours()}-${String(currentDate.getMinutes()).padStart(2, '0')}`;
    link.click();
}

      

document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            // 1. Decode the Base64 back to a JSON string
            const decoded = decodeURIComponent(escape(atob(e.target.result)));
            
            // 2. Parse that string into a JavaScript Object
            const contents = JSON.parse(decoded);
            
            // 3. (Optional) Clear current storage if you want a clean overwrite
            // localStorage.clear();

          localStorage.clear();
            // 4. Loop through the object and save each key-value pair to localStorage
            Object.keys(contents).forEach(key => {
                localStorage.setItem(key, contents[key]);
            });


            // 5. Reload the page so the app UI updates with the new data
            location.reload(); 
            
        } catch (err) {
            console.error(err); // Helpful for debugging in the console
            alert("Error: File is corrupted or invalid.");
        }
    };

    reader.readAsText(file);
});
      
    </script>
  </body>
</html>
