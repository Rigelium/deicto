<!DOCTYPE html>
<html>
  <head>
            <!--Stuff for da browser and embeds-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Deicto">
    <meta property="og:description" content="Deicto is a free, non-profit platform for expanding your vocabulary in foreign languages.">
    <meta property="og:image" content="https://rigelium.github.io/deicto/assets/logo.png">
    <link rel="icon" type="image/x-icon" href="https://rigelium.github.io/deicto/assets/logo_cat.png">

    <link rel="icon" type="image/x-icon" href="https://cdn.discordapp.com/attachments/638813266440880140/1452871487945048154/image.png?ex=694b6383&is=694a1203&hm=ea28a03cd258d23b8acf516ce5d50e8d8c18830545825d3c39ad702c7ab846fc">
    <link rel="stylesheet" href="../assets/styles.css">

    <title>Deicto | Levels</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div style="position: fixed; top: 0px; right: 0px; width: 100%; height: 80px; background-color: black; display: flex; justify-content: space-between; align-items: center;">
      <div onclick='window.location.href=("../")' style="height: 80%; margin: 10px;"><img src="../assets/logo.png" style="height: 100%;"></div>
      <div style="display: flex; justify-content: flex-end; flex-direction: column; justify-content: space-between; height: 40%; margin-right: 10px;">      
      <div style="width: 40px; height: 6px; background-color: white; border-radius: 3px;"></div>
      <div style="width: 40px; height: 6px; background-color: white; border-radius: 3px;"></div><div style="width: 40px; height: 6px; background-color: white; border-radius: 5px;"></div>
      </div>
    </div>
    <div style="height: 90px;"></div>

    <div class='box1' style='justify-content: flex-start; gap: 10px;'>
      <div style="display: flex; flex-direction: column; width: 40%; gap: 10px;">
        <img id = 'flag' src='' style="width: 100%; height: auto; border-radius: 10px; box-shadow: 5px 5px 10px #000000ba">
        <a id='info-language' style='font-weight: bold; font-size: 1.5rem;'>Loading levels...</a>
        <a id='info-dif-level' style='color: var(--fontcolor3)'></a>
      </div>
      <div style='width: 55%'>
        <div style="display: flex; flex-direction: column;">
          <a style='font-weight: bold; font-size: 1.5rem; margin-bottom: 10px;'>Statistics</a>
          <a style='color: var(--fontcolor3)'>Levels completed with 1★: [WIP]</a>
          <a style='color: var(--fontcolor3)'>Levels completed with 5★: [WIP]</a>
          <a style='color: var(--fontcolor3)'>Total stars collected: [WIP]</a>
        </div>
      </div>
    </div>
    <div id='review-visibility' style='display: none;'>
      <div class='box1' style='margin-top: 20px;'><a style='font-size: 1.5rem; font-weight: bold'>Ready for review</a></div>
      <div id='review-container' style="gap: 10px;"></div>
    </div>
    <div class='box1' style='margin-top: 20px;'><a style='font-size: 1.5rem; font-weight: bold'>All levels</a></div>
    <div id='lv-container' style="gap: 10px;"></div>

    
    <script>

      // Trying to load data from the main page (COURSE SETTINGS)
      let language = retrieveVariable("language", 'Spanish');
      let langCodeTTS = retrieveVariable("langCodeTTS", 'es-ES'); 
      let difLevel = retrieveVariable(`${language}-difLevel`, "beginner");
      
      const path = language.toLowerCase() + "/" + difLevel + "/";


      

      //------------------------------------------------------------------------------------------------------------------------
      listLevels();

      async function listLevels() {
      let checkedLv = 1;
      let endReached = 0;
        while( endReached == 0 ) {
          try {
            const response = await fetch(path + "lv_" + checkedLv + ".json");
            levelData = await response.json();
            dispLevel(checkedLv, levelData.title, levelData.sentences.length); // 
            updateInfo();
            checkedLv++;
          } catch(error) {
            endReached = 1;
            console.log(error);
          } 
        }
      }


      function dispLevel(levelNumber, levelTitle, numOfSentences) {

              // USER DATA FOR A LEVEL
        const localPath = `-${language}-${difLevel}-${levelNumber}`;

        let currentSentence = Number(retrieveVariable(`currentSentence${localPath}`, 0));
        let starCount = Number(retrieveVariable(`starCount${localPath}`, 0));


        let starsHTML = '';
        for (let i = 0; i < starCount; i++) {
          starsHTML += `
          <img style = 'height: 1em; width: auto;' src='../assets/starfilled.png'>\n
          `;
        }
        for (let i = 0; i < 5-starCount; i++) {
          starsHTML += `
          <img style = 'height: 1em; width: auto;' src='../assets/starhollow.png'>\n
          `;
        }

        let reviewMs = Number(retrieveVariable(`nextReview${localPath}`)) - Date.now();
        let reviewString = reviewToString(reviewMs, starCount);
        
        const lvContainer = document.getElementById('lv-container');
        const level = document.createElement('div');
        levelHTML = `
        <div class='box1' style="margin-top: 10px;">
          <div style='width:60%; display: flex; flex-direction: column; gap: 10px; justify-content: flex-start;'>
            <a style='font-weight: bold;'>Lv. ${levelNumber} - ${levelTitle}</a>
            <div style="display: flex;"> <!--  -->
              <div style="display: flex; flex-direction: column; width: 50%; gap: 10px;">
                <div style='display: flex; gap: 1px;'>${starsHTML}</div>
                <a style='color: var(--fontcolor3)'>${reviewString}</a>
              </div>
              <div style="display: flex; flex-direction: column; width: 40%; gap: 10px;">
                <a style='color: var(--fontcolor3)'>${currentSentence}/${numOfSentences}</a>
                <div style="display: flex; height: 10px; border-radius: 5px; background-color: var(--grayish)">
                  <div style="display: flex; border-radius: 5px; width: ${Number(currentSentence/numOfSentences*100)}%; background: var(--boxgradient1)">
                  </div>
                </div>
              </div>
              
            </div>
          </div>
          <div style="display: flex; flex-direction: column; width: 20%; gap: 5px;">
            <div class="box3" onclick="toPdf('${levelNumber}', '${levelTitle}')">
              <img src="../assets/book.png" style="height: 1rem;">
              <a>notes</a>
            </div>
            <div class="box3">
              <img src="../assets/more.png" style='height: 1rem;'>
              <a>more</a>
          </div></div>
          <div class="box2" style='width: 12%; display: flex; flex-direction: column; gap: 3px; align-items: center' onclick='selectLevel(${levelNumber})'>
            <img src="../assets/play.png" style="height: 25px;">
            <a>play</a>
          </div>
        </div>`;
        level.innerHTML = levelHTML;
        lvContainer.appendChild(level);

        const reviewVisibility = document.getElementById('review-visibility');
        const reviewContainer = document.getElementById('review-container');
        if (reviewString == 'ready for review'){
          const reviewLevel = document.createElement('div');
          reviewLevel.innerHTML = levelHTML;
          reviewContainer.appendChild(reviewLevel);
          reviewVisibility.style.display = 'block';
        }

        
        console.log("Loaded level: " + levelNumber + levelTitle + numOfSentences);
      }


      function reviewToString(reviewMs, starCount){
        if (starCount==0){
          return 'play to get stars';
        }
        if (starCount==5){
          return 'level complete';
        }
        if (reviewMs <= 0){
          return 'ready for review';
        }
        let output = 'Review: ';
        const reviewMin = reviewMs/60000;
        
        const minutesLeft = Math.floor(reviewMin) % 60;
        const hoursLeft = Math.floor(reviewMin/60) % 24;
        const daysLeft = Math.floor(reviewMin/60/24); 

        if (reviewMin < 1){
          output += `${Math.floor(reviewMs/1000)}s`
          return output;
        }
        if (daysLeft != 0) { 
          output += `${daysLeft}d `
        }
        if (hoursLeft != 0) { 
          output += `${hoursLeft}h `
        }
        if (minutesLeft != 0) { 
          output += `${minutesLeft}m`
        }
      
        return output;
      }
      
      function selectLevel(levelNr) {
        localStorage.setItem('currentLevel', levelNr);
        window.location.href = `../play/`;
      }

      function updateInfo() {
        const flag = document.getElementById('flag');
        flag.src = `../assets/flags/${language}.png`

        const infoLanguage = document.getElementById('info-language');
        infoLanguage.textContent = language;

        const infoDifLevel = document.getElementById('info-dif-level');
        infoDifLevel.textContent = difLevel;
      }


      async function toPdf(lvNumber, lvTitle) {
        try {
          const responsePdf = await fetch(path + "lv_" + lvNumber + ".json");
          levelDataPdf = await responsePdf.json();
        } catch(error) {
          console.log(error);
        } finally {
          let sentencesPdf = levelDataPdf.sentences;
          generatePdf(lvNumber, lvTitle, sentencesPdf);
        }
      }
      
      function generatePdf(lvNumber, lvTitle, sentencesPdf) {

        let currentPage = 1;
        const img = new Image();
        img.src = ('../assets/logo.png');
        const flag = new Image();
        flag.src = (`../assets/flags/${language}.png`);

        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        //header
        const pageWidth = doc.internal.pageSize.getWidth();
        doc.setFillColor(36, 33, 37); 
        doc.rect(0, 0, pageWidth, 40, 'F');

        doc.addImage(img, 'PNG', 10, 10, 46.877, 20);
        doc.addImage(flag, 'PNG', pageWidth - 40 , 10, 30, 20);

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(15);
        doc.text(`${language} - ${difLevel}`, 60, 15);
        doc.setTextColor(200, 200, 200);
        doc.setFontSize(10);
        doc.text(`Lv. ${lvNumber} - ${lvTitle}, printable version`, 60, 20);
        doc.text(`Visit rigelium.github.io/deicto/ for more exercises`, 60, 25);


        //entries
        const entryHeight = 20;
        const baseHeight = 50;
        let totalHeight = baseHeight - entryHeight;  


        for (let i = 0; i < levelData.sentences.length; i++) {
          let answers = randomizeOrder([4, 5, 6, 7]);
          totalHeight += entryHeight;  
          if (totalHeight >= 260) {
            let lineTop = 0;
            if (currentPage > 1){
              lineTop = 40;
            }
            //splitting line
        doc.setLineDash([2, 2]);
        doc.line(160, lineTop, 160, 297);

            doc.addPage();
            totalHeight = totalHeight-260;
        
          } 

          if (i % 2 == 1){
            doc.setFillColor(220, 220, 220); 
            doc.rect(0, totalHeight-5, pageWidth, entryHeight, 'F');
          }
          
          doc.setTextColor(0, 0, 0);
          doc.text(`${i+1}. ${sentencesPdf[i][0]} ........................ ${sentencesPdf[i][2]}`, 10, totalHeight);
          doc.text(`${sentencesPdf[i][1]}`, 170, totalHeight + 5);
          doc.setTextColor(180, 180, 180);
          doc.text(sentencesPdf[i][3], 10, totalHeight + 5);
          doc.text(`a.) ${sentencesPdf[i][answers[0]]} b.) ${sentencesPdf[i][answers[1]]} c.) ${sentencesPdf[i][answers[2]]} d.) ${sentencesPdf[i][answers[3]]}`, 10, totalHeight + 10);
          
        }
        
        //saving
        doc.save(`${language}_${difLevel}_${lvNumber}_${lvTitle}.pdf`);
      }



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      function retrieveVariable(varName, defaultValue) {
        try {
          const storedValue = localStorage.getItem(varName);
          if (storedValue == null){
            return defaultValue;
          }
          return storedValue;
        } catch(error) {
          console.error(error);
          return defaultValue;
        }
      }


      function randomizeOrder(array) {
    for (let i = array.length - 1; i > 0; i--) {
        // Pick a random index from 0 to i
        const j = Math.floor(Math.random() * (i + 1));
        
        // Swap elements at i and j
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
      
    </script>
  </body>
</html>
