<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
<meta property="og:title" content="Deicto | Level Menu">
<meta property="og:description" content="A silly language learning game made by an even sillier student">
<meta property="og:image" content="https://rigelium.github.io/deicto/assets/logo.png">
    <link rel="icon" type="image/x-icon" href="https://cdn.discordapp.com/attachments/638813266440880140/1452871487945048154/image.png?ex=694b6383&is=694a1203&hm=ea28a03cd258d23b8acf516ce5d50e8d8c18830545825d3c39ad702c7ab846fc">
    <link rel="stylesheet" href="../assets/styles.css">
    <title>Deicto</title>
  </head>

  
  <body>

    <div class='box1' style='justify-content: flex-start; gap: 10px;'>
      <div style="display: flex; flex-direction: column; width: 40%; gap: 10px;">
        <img id = 'flag' src='' style="width: 100%; height: auto; border-radius: 10px;">
        <a id='info-language' style='font-weight: bold; font-size: 1.5rem;'>Loading levels...</a>
        <a id='info-dif-level' style='color: var(--fontcolor3)'></a>
      </div>
      <div style='width: 55%'>
        <div style="display: flex; flex-direction: column;">
          <a style='font-weight: bold; font-size: 1.5rem; margin-bottom: 10px;'>Statistics</a>
          <a style='color: var(--fontcolor3)'>Levels completed with 1★: [WIP]</a>
          <a style='color: var(--fontcolor3)'>Levels completed with 5★: [WIP]</a>
          <a style='color: var(--fontcolor3)'>Total stars collected: [WIP]</a>
        </div>
      </div>
    </div>
    <a style='font-size: 1.5rem; font-weight: bold'>Ready for review</a>
    <div id='review-container' style="gap: 10px;"></div>
    <a style='font-size: 1.5rem; font-weight: bold'>All levels</a>
    <div id='lv-container' style="gap: 10px;"></div>

    
    <script>

      // Trying to load data from the main page (COURSE SETTINGS)
      let language = retrieveVariable("language", 'Spanish');
      let langCodeTTS = retrieveVariable("langCodeTTS", 'es-ES'); 
      let difLevel = retrieveVariable("difLevel", "beginner");
      
      const path = language.toLowerCase() + "/" + difLevel + "/";


      

      //------------------------------------------------------------------------------------------------------------------------
      listLevels();

      async function listLevels() {
      let checkedLv = 1;
      let endReached = 0;
        while( endReached == 0 ) {
          try {
            const response = await fetch(path + "lv_" + checkedLv + ".json");
            levelData = await response.json();
            dispLevel(checkedLv, levelData.title, levelData.sentences.length); // 
            updateInfo();
            checkedLv++;
          } catch(error) {
            endReached = 1;
            console.log(error);
          } 
        }
      }


      function dispLevel(levelNumber, levelTitle, numOfSentences) {

              // USER DATA FOR A LEVEL
        const localPath = `-${language}-${difLevel}-${levelNumber}`;

        let currentSentence = Number(retrieveVariable(`currentSentence${localPath}`, 0));
        let starCount = Number(retrieveVariable(`starCount${localPath}`, 0));


        let starsHTML = '';
        for (let i = 0; i < starCount; i++) {
          starsHTML += `
          <img style = 'height: 1em; width: auto;' src='../assets/starfilled.png'>\n
          `;
        }
        for (let i = 0; i < 5-starCount; i++) {
          starsHTML += `
          <img style = 'height: 1em; width: auto;' src='../assets/starhollow.png'>\n
          `;
        }

        let reviewMs = Number(retrieveVariable(`nextReview${localPath}`)) - Date.now();
        let reviewString = reviewToString(reviewMs, starCount);
        
        const lvContainer = document.getElementById('lv-container');
        const level = document.createElement('div');
        levelHTML = `
        <div class='box1' style="margin-top: 10px;">
          <div style='width:60%; display: flex; flex-direction: column; gap: 10px; justify-content: flex-start;'>
            <a style='font-weight: bold;'>Lv. ${levelNumber} - ${levelTitle}</a>
            <div style="display: flex;"> <!--  -->
              <div style="display: flex; flex-direction: column; width: 50%; gap: 10px;">
                <div style='display: flex; gap: 1px;'>${starsHTML}</div>
                <a style='color: var(--fontcolor3)'>${reviewString}</a>
              </div>
              <div style="display: flex; flex-direction: column; width: 50%; gap: 10px;">
                <a style='color: var(--fontcolor3)'>${currentSentence}/${numOfSentences}</a>
                <div style="display: flex; height: 10px; border-radius: 5px; background-color: var(--grayish)">
                  <div style="display: flex; border-radius: 5px; width: ${Number(currentSentence/numOfSentences*100)}%; background-color: var(--blueish)">
                  </div>
                </div>
              </div>
              
            </div>
          </div>
          <div class="box1" style='width: 20%; background-color: var(--blueish)' onclick='selectLevel(${levelNumber})'>
            <a>PLAY</a>
          </div>
        </div>`;
        level.innerHTML = levelHTML;
        lvContainer.appendChild(level);

        const reviewContainer = document.getElementById('review-container');
        if (reviewString == 'ready for review'){
          const reviewLevel = document.createElement('div');
          reviewLevel.innerHTML = levelHTML;
          reviewContainer.appendChild(reviewLevel);
        }

        
        console.log("Loaded level: " + levelNumber + levelTitle + numOfSentences);
      }


      function reviewToString(reviewMs, starCount){
        if (starCount==0){
          return 'play to get stars';
        }
        if (starCount==5){
          return 'level complete';
        }
        if (reviewMs <= 0){
          return 'ready for review';
        }
        let output = 'Review: ';
        const reviewMin = reviewMs/60000;
        
        const minutesLeft = Math.floor(reviewMin) % 60;
        const hoursLeft = Math.floor(reviewMin/60) % 24;
        const daysLeft = Math.floor(reviewMin/60/24); 

        if (reviewMin < 1){
          output += `${Math.floor(reviewMs/1000)}s`
          return output;
        }
        if (daysLeft != 0) { 
          output += `${daysLeft}d `
        }
        if (hoursLeft != 0) { 
          output += `${hoursLeft}h `
        }
        if (minutesLeft != 0) { 
          output += `${minutesLeft}m`
        }
      
        return output;
      }
      
      function selectLevel(levelNr) {
        localStorage.setItem('currentLevel', levelNr);
        window.location.href = `../play/`;
      }

      function updateInfo() {
        const flag = document.getElementById('flag');
        flag.src = `../assets/flags/${language}.png`

        const infoLanguage = document.getElementById('info-language');
        infoLanguage.textContent = language;

        const infoDifLevel = document.getElementById('info-dif-level');
        infoDifLevel.textContent = difLevel;
      }





////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      function retrieveVariable(varName, defaultValue) {
        try {
          const storedValue = localStorage.getItem(varName);
          if (storedValue == null){
            return defaultValue;
          }
          return storedValue;
        } catch(error) {
          console.error(error);
          return defaultValue;
        }
      }
      
    </script>
  </body>
</html>
