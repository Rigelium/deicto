<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
<meta property="og:title" content="Deicto">
<meta property="og:description" content="A silly language learning game made by an even sillier student">
<meta property="og:image" content="https://rigelium.github.io/deicto/assets/logo.png">

      
    <link rel="icon" type="image/x-icon" href="https://cdn.discordapp.com/attachments/638813266440880140/1452871487945048154/image.png?ex=694b6383&is=694a1203&hm=ea28a03cd258d23b8acf516ce5d50e8d8c18830545825d3c39ad702c7ab846fc">
    <link rel="stylesheet" href="../assets/styles.css">
    <title>Deicto</title>
   <style>
     #btn-container a{
       text-decoration: none;
       color: var(--fontcolor2);  
     }
     #btn-container a:hover{
       color: var(--highlight);  
     }
     .blank-button{
       background: var(--blankcolor); 
       border-radius: 2px; 
       margin: 0 2 0 2;
       padding: 1 2 1 2;
     }
     .answer{
       border-radius: 5px;
       background-color: var(--boxcolor1);
       padding: 10px;
       height: 50px;
     }
     #dictionary-container a {
       display: block;
       white-space: pre-wrap; 
       text-decoration: none;
       color: var(--text-white);
     }
   </style>
  </head>
<body>
  <div style="display: flex; flex-direction: column; justify-content: center; gap: 15px;">
    <div class="box1" style="display: flex; flex-direction: column; gap: 3px;">
      <div id="btn-container" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;"></div>
      <a id="notes-desc" style='display: flex; flex-direction: column; gap: 3px;'></a>
      <a id="translated" style="color: var(--fontcolor3); text-align: center;"></a>
    </div>
    <div id=dictionary-container></div>
    <div id="notes-container"></div>
    <div id="answer-container" style="display: flex; flex-direction: column; gap: 10px;"></div>
    <div id="cont-container"></div>
  </div>
  <script>

    window.onload = loadLevelData;

    
    

    // USER SETTINGS
    
    // COURSE SETTINGS
    let language = retrieveVariable("language", 'Spanish');
    let langCodeTTS = retrieveVariable("langCodeTTS", 'es-ES'); 
    let difLevel = retrieveVariable("difLevel", "beginner");
    // LEVEL SETTING
    let currentLevel = retrieveVariable("currentLevel", "1"); 

    const localPath = `-${language}-${difLevel}-${currentLevel}`;

    let currentSentence = Number(retrieveVariable(`currentSentence${localPath}`, 0));
    let starCount = Number(retrieveVariable(`starCount${localPath}`, 0));

    let reordered = [];

    // LEVEL DATA LOADING --------------------------------------------------------------------------------
    let levelData, sentencesHu, lvTitle, notes = null;
    async function loadLevelData() {
      try {
        const response = await fetch("../levels/" + language.toLowerCase() + "/" + difLevel + "/lv_" + currentLevel + ".json");
        levelData = await response.json();        
        lvTitle = levelData.title;
        sentencesHu = levelData.sentences;  
        notes = levelData.dictionary;

        for (let i = 0; i < sentencesHu.length; i++) {
          reordered[i] = retrieveVariable(`reordered${localPath}-${i}`, i);
        }

        
        if (currentSentence == 0){
          displayNotes();
        } else {
          generateSentence();
        }
      } catch (error) {
        console.error("Failed to load level data.", error);
      }
    }
    //////////////////////////////////////////////////////////////////////


    //////////////////////////////////////////////////////////////////////////////notes/////////////////////////////////////////////////////////////////////////////////////////
    function displayNotes() {
      const notesContainer = document.getElementById('notes-container');
      const dictionaryContainer = document.getElementById('dictionary-container');
      
      const notesBox = document.createElement('div');
      const notesContinue = document.createElement('div');
      const notesText = document.createElement('a');
      const notesContinueText = document.createElement('a');


      //document.getElementById('notes-desc').textContent = "Notes for the following level: " + "Level " + currentLevel + " - " + lvTitle + " [" + language + " - " + difLevel + "]";
      document.getElementById('notes-desc').innerHTML = `
      <a style="font-size: 2rem; font-weight: bold">Notes</a>
      <a style=''>Level ${currentLevel} - "${lvTitle}"</a>
      <a style='color: var(--fontcolor3)'>${language} - ${difLevel}</a>
      `
    
      notesBox.className = "box1";
      notesBox.style.justifyContent = "flex-start";
      notesContinue.className = "box1";
      notesContinue.style.backgroundColor = "var(--blueish)";
      notesText.textContent = notes;
      notesText.style.cssText = "line-height: 1.2rem;";
      notesContinueText.textContent = "Continue";
      
      notesContinue.addEventListener('click', () => {
        notesContainer.replaceChildren();
        dictionaryContainer.replaceChildren();
        document.getElementById('notes-desc').innerHTML = "";
        generateSentence();
      });

      notesContinue.appendChild(notesContinueText);
      notesBox.appendChild(notesText);
      notesContainer.appendChild(notesContinue);
      dictionaryContainer.appendChild(notesBox);
    }


    //=======================================================================================================================================================
    
    function generateSentence() {
      
      // GENERATING SENTENCE 
      container = document.getElementById("btn-container");

      for(let i = 0; i<sentencesHu[reordered[currentSentence]][0].split(" ").length ; i++){
        const btn = document.createElement('a');
        btn.textContent = sentencesHu[reordered[currentSentence]][0].split(" ")[i];
        btn.href = "https://en.wiktionary.org/wiki/" + btn.innerText.replace(/[.,?!]/g, "") + "#" + language;
        container.appendChild(btn); 
      }
      
      const btn = document.createElement('a');
        btn.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
        btn.className = "blank-button";
        btn.id = "hidden";
        container.appendChild(btn);
      
      for(let i = 0; i<sentencesHu[reordered[currentSentence]][2].split(" ").length ; i++){
        const btn = document.createElement('a');
        btn.textContent = sentencesHu[reordered[currentSentence]][2].split(" ")[i];
        btn.href = "https://en.wiktionary.org/wiki/" + btn.innerText.replace(/[.,?!]/g, "") + "#" + language;
        container.appendChild(btn);
      }

      //GENERATE THE TRANSLATION
      const translated = document.getElementById('translated');
      translated.textContent = sentencesHu[reordered[currentSentence]][3];
    

    //GENERATE THE ANSWERS 4444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444
    const answerContainer = document.getElementById("answer-container");
    const answer = [];
    const answerText = [];
    let answerGiven = 0;
    for(let i = 0; i < 4; i++){
      answer[i] = document.createElement('div');
      answer[i].className = "answer";
      
      answerText[i] = document.createElement('a');
      answerText[i].textContent = sentencesHu[reordered[currentSentence]][i+4];

      answer[i].addEventListener('click', () =>{
        if(answerGiven == 0){
        const rightAnswer = document.getElementById('hidden');
        rightAnswer.textContent = sentencesHu[reordered[currentSentence]][1].split('(')[0];
        rightAnswer.style.backgroundColor = 'var(--boxcolor1)';
        rightAnswer.style.color = 'var(--blueish)';
        rightAnswer.href = "https://en.wiktionary.org/wiki/" + sentencesHu[reordered[currentSentence]][1] + "#" + language;

          //SENTENCE ANSWERED
        const fullSentence = sentencesHu[reordered[currentSentence]][0] + sentencesHu[reordered[currentSentence]][1].split('(')[0].trim() + sentencesHu[reordered[currentSentence]][2];
        playText(fullSentence, langCodeTTS);



          
          
        showContinue(fullSentence);
        if (answerText[i].textContent==sentencesHu[reordered[currentSentence]][1]){
          //CORRECT CHOICE

          if(currentSentence == sentencesHu.length-1) {
            if ( starCount < 5 && Number(retrieveVariable(`nextReview${localPath}`, 0)) <= Date.now()) {
              starCount++;
            }
            localStorage.setItem(`starCount${localPath}`, starCount);
            localStorage.removeItem(`currentSentence${localPath}`);
            
            for (let i = 0 ; i < sentencesHu.length ; i++){
              localStorage.removeItem(`reordered${localPath}-${i}`);
            }
            //setting time for the next review
            //reviewTime = [0, 3600000 /* 1hr */, 86400000 /* 1day */, 604800000 /*1week*/, 2592000000 /*1month*/];
            reviewTime = [0, 60000 /* 2min */, 3660000 /* 1hr 1min */, 86410000 /*1 day 1 min*/, 2592000000 /*1month*/];
            if (starCount > 0 && Number(retrieveVariable(`nextReview${localPath}`, 0)) <= Date.now()){
              localStorage.setItem(`nextReview${localPath}`, Date.now()+reviewTime[starCount]);
            }
            


            
            console.log('U have beaten the final level, ggz'); //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<------oidsaufoiuewio
          }

          
          answer[i].style.backgroundColor = "var(--blueish)";
          currentSentence++;
          if(currentSentence != sentencesHu.length){
            console.log(`this stupid shit runs again, sentence ${currentSentence}`);
            localStorage.setItem(`currentSentence${localPath}`, currentSentence)
          }
        }else{
          reorder(reordered, currentSentence);

          for (let i = 0 ; i < sentencesHu.length ; i++){
            localStorage.setItem(`reordered${localPath}-${i}`, reordered[i]);
          }

          
          //localStorage.setItem(`reordered${localPath}-${i}`, i)
          answer[i].style.backgroundColor = "red";
        }
        answerGiven = 1;
        }
      });
      
      answerContainer.appendChild(answer[i]);
      answer[i].appendChild(answerText[i]);
    }
    
    //GENERATE THE CONTINUE BUTTON
    function showContinue(fullSent){
      contContainer = document.getElementById('cont-container');
      const cont = document.createElement('div');
      cont.className="box1";

      const repeatTTS = document.createElement('div');
      repeatTTS.className="box1";
      repeatTTS.addEventListener('click', ()=>{
        playText(fullSent, langCodeTTS);
      });
      repeatTTS.style.backgroundColor="var(--highlight)";
      repeatTTS.style.width = "30%";
      
      //cont.style.backgroundColor="var(--grayish)";

      const nextSent = document.createElement('div');
      nextSent.className="box1";
      nextSent.style.backgroundColor="var(--highlight)";
      nextSent.style.width = "30%";

      const nextSentText = document.createElement('a');
      nextSentText.textContent = "Continue";
      
      
      nextSent.addEventListener("click", () => {
        
        contContainer.replaceChildren();
        container.replaceChildren();
        answerContainer.replaceChildren();


        if(currentSentence == sentencesHu.length) {
            console.log('U have reached the end screen GGZ!!'); ////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
        } else {
          generateSentence();
        }
      });

      contContainer.appendChild(cont);
        cont.appendChild(nextSent);
          nextSent.appendChild(nextSentText);
        cont.appendChild(repeatTTS);      
      
      }
    }
    //////////////////////////////////////////////////////////////TSS HERE
    /*function playText(text, langCode) {
    // 1. Create a "shout" object
    const utterance = new SpeechSynthesisUtterance(text);
    
    // 2. Set the language (e.g., 'hu-HU', 'pl-PL', 'de-DE')
    utterance.lang = langCode;
    
    // 3. Optional: Adjust pitch and rate for better clarity
    utterance.rate = 1.0; // Slightly slower than normal for learners
    utterance.pitch = 1.0;

    // 4. Speak!
    window.speechSynthesis.speak(utterance);
    }*/

function playText(text, langCode) {
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    const shortCode = langCode.split('-')[0].toLowerCase();

    // 1. Attempt to find a LOCAL voice first
    let selectedVoice = voices.find(v => 
        v.lang.toLowerCase().replace('_', '-').startsWith(shortCode) && 
        v.localService === true
    );

    // 2. FALLBACK: If no local voice, look for a Google/Network voice
    if (!selectedVoice) {
        console.log(`No native voice found for ${langCode}. Searching for Google fallback...`);
        selectedVoice = voices.find(v => 
            v.lang.toLowerCase().replace('_', '-').startsWith(shortCode) && 
            (v.name.includes("Google") || v.localService === false)
        );
    }

    // 3. LAST RESORT: Just pick the first voice that matches the language at all
    if (!selectedVoice) {
        selectedVoice = voices.find(v => 
            v.lang.toLowerCase().replace('_', '-').startsWith(shortCode)
        );
    }

    if (selectedVoice) {
        utterance.voice = selectedVoice;
        console.log(`Using voice: ${selectedVoice.name} (Local: ${selectedVoice.localService})`);
    } else {
        console.warn(`Absolutely no voice found for ${langCode}. Using system default.`);
        utterance.lang = langCode; 
    }

    window.speechSynthesis.speak(utterance);
}
    
    /////////////////////////////////////////////////////////////////////////////////////RETRIEVE DATA
    function retrieveVariable(varName, defaultValue) {
        try {
          const storedValue = localStorage.getItem(varName);
          if (storedValue == null){
            return defaultValue;
          }
          return storedValue;
        } catch(error) {
          console.error(error);
          return defaultValue;
        }
      }
////////////////////////////////////////////////////////////////////////
    function reorder(array, index) {
    const item = array.splice(index, 1)[0]; 
    array.push(item);
    return array;
}
  </script>
</body>
</html>
